# üìñ DOCUMENTATION.md - Documentaci√≥n T√©cnica Completa

**Proyecto:** BalconazoApp  
**Versi√≥n Backend:** 1.0.0  
**Fecha:** Octubre 2025

Este documento proporciona una visi√≥n t√©cnica detallada de la arquitectura, dise√±o y funcionamiento del sistema.

---

## üìã Tabla de Contenidos

1. [Arquitectura del Sistema](#arquitectura-del-sistema)
2. [Microservicios](#microservicios)
3. [Modelo de Datos](#modelo-de-datos)
4. [Autenticaci√≥n y Seguridad](#autenticaci√≥n-y-seguridad)
5. [Flujos de Negocio](#flujos-de-negocio)
6. [Comunicaci√≥n Entre Servicios](#comunicaci√≥n-entre-servicios)
7. [Manejo de Errores](#manejo-de-errores)
8. [Endpoints API](#endpoints-api)
9. [Tests Automatizados](#tests-automatizados)
10. [Buenas Pr√°cticas Implementadas](#buenas-pr√°cticas-implementadas)

---

## üèóÔ∏è Arquitectura del Sistema

### Patr√≥n Arquitect√≥nico

**BalconazoApp** implementa una **arquitectura de microservicios** basada en los principios de:

- **Domain-Driven Design (DDD)**: Cada microservicio tiene su dominio claramente definido
- **Event-Driven Architecture**: Comunicaci√≥n as√≠ncrona v√≠a Kafka
- **API Gateway Pattern**: Punto de entrada √∫nico
- **Service Discovery**: Registro din√°mico con Eureka
- **Circuit Breaker**: Resiliencia con Resilience4j
- **CQRS parcial**: Separaci√≥n de lectura (Search) y escritura (Catalog)

### Diagrama de Componentes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         CLIENTE HTTP                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      API GATEWAY (8080)                          ‚îÇ
‚îÇ  - Rate Limiting                                                 ‚îÇ
‚îÇ  - Authentication Check                                          ‚îÇ
‚îÇ  - Routing                                                       ‚îÇ
‚îÇ  - Circuit Breaker                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ                      ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  EUREKA SERVER    ‚îÇ  ‚îÇ   REDIS CACHE    ‚îÇ
        ‚îÇ    (8761)         ‚îÇ  ‚îÇ     (6379)       ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                        ‚îÇ                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AUTH SERVICE  ‚îÇ   ‚îÇ CATALOG SERVICE‚îÇ   ‚îÇ BOOKING SERVICE‚îÇ
‚îÇ    (8084)      ‚îÇ   ‚îÇ     (8085)     ‚îÇ   ‚îÇ     (8082)     ‚îÇ
‚îÇ                ‚îÇ   ‚îÇ                ‚îÇ   ‚îÇ                ‚îÇ
‚îÇ  - JWT Auth    ‚îÇ   ‚îÇ  - Spaces CRUD ‚îÇ   ‚îÇ  - Bookings    ‚îÇ
‚îÇ  - Users       ‚îÇ   ‚îÇ  - Availability‚îÇ   ‚îÇ  - Reviews     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                    ‚îÇ                     ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  MySQL  ‚îÇ          ‚îÇ  Postgre‚îÇ          ‚îÇ  Postgre‚îÇ
    ‚îÇ  (3307) ‚îÇ          ‚îÇ   SQL   ‚îÇ          ‚îÇ   SQL   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ  (5433) ‚îÇ          ‚îÇ  (5434) ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ   KAFKA (9092)       ‚îÇ
                   ‚îÇ  - Space Events      ‚îÇ
                   ‚îÇ  - Booking Events    ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ  SEARCH SERVICE      ‚îÇ
                   ‚îÇ     (8083)           ‚îÇ
                   ‚îÇ                      ‚îÇ
                   ‚îÇ  - Geo Search        ‚îÇ
                   ‚îÇ  - Event Consumer    ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚îÇ Postgre ‚îÇ
                          ‚îÇ  +GIS   ‚îÇ
                          ‚îÇ (5435)  ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Microservicios

### 1. API Gateway (Puerto 8080)

**Responsabilidades:**
- Punto de entrada √∫nico al sistema
- Enrutamiento de peticiones a microservicios
- Validaci√≥n b√°sica de JWT
- Rate limiting (5 req/s por IP)
- Circuit breaker para resilencia
- CORS y headers de seguridad

**Tecnolog√≠as:**
- Spring Cloud Gateway
- Spring Security (OAuth2 Resource Server)
- Resilience4j (Circuit Breaker)
- Redis (Rate Limiter)

**Rutas Configuradas:**

| Ruta | Destino | Filtros |
|------|---------|---------|
| `/api/auth/**` | auth-service | P√∫blico |
| `/api/catalog/**` | catalog-service | JWT requerido |
| `/api/booking/**` | booking-service | JWT requerido |
| `/api/search/**` | search-service | P√∫blico |

**Configuraci√≥n de Circuit Breaker:**

```yaml
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
```

---

### 2. Eureka Server (Puerto 8761)

**Responsabilidades:**
- Service Discovery
- Health monitoring
- Load balancing side

**Dashboard:** http://localhost:8761

**Servicios registrados:**
- api-gateway
- auth-service
- catalog-service
- booking-service
- search-service

---

### 3. Auth Service (Puerto 8084)

**Responsabilidades:**
- Registro de usuarios
- Autenticaci√≥n con JWT
- Gesti√≥n de roles (HOST, GUEST, ADMIN)
- Refresh tokens
- Perfil de usuario

**Base de Datos:** MySQL (`auth_db`)

**Entidades:**
- `User` (id, email, passwordHash, role, status, trustScore)

**Endpoints Principales:**

```http
POST   /api/auth/register
POST   /api/auth/login
POST   /api/auth/refresh
GET    /api/auth/me
PUT    /api/auth/profile
```

**JWT Claims:**
```json
{
  "sub": "userId",
  "email": "user@example.com",
  "role": "HOST",
  "iat": 1234567890,
  "exp": 1234567890
}
```

**Algoritmo:** HS512 (symmetric)  
**Secret:** Variable de entorno `JWT_SECRET`  
**Expiraci√≥n:** 24 horas

---

### 4. Catalog Service (Puerto 8085)

**Responsabilidades:**
- CRUD de espacios
- Gesti√≥n de disponibilidad
- Activaci√≥n/desactivaci√≥n de espacios
- Cach√© de espacios con Redis

**Base de Datos:** PostgreSQL (`catalog_db`)

**Entidades:**
- `Space` (id, title, description, ownerId, lat, lon, capacity, price, amenities, status)
- `AvailabilitySlot` (id, spaceId, startTime, endTime, isAvailable)
- `User` (replica para integridad referencial)

**Endpoints Principales:**

```http
POST   /api/catalog/spaces
GET    /api/catalog/spaces
GET    /api/catalog/spaces/{id}
PUT    /api/catalog/spaces/{id}
POST   /api/catalog/spaces/{id}/activate
GET    /api/catalog/spaces/owner/{ownerId}
GET    /api/catalog/spaces/active
```

**Eventos Kafka Publicados:**
- `SpaceCreatedEvent`
- `SpaceUpdatedEvent`
- `SpaceActivatedEvent`

**Estrategia de Cach√©:**
- Key: `space:{id}`
- TTL: 5 minutos
- Invalidaci√≥n: al actualizar/eliminar

---

### 5. Booking Service (Puerto 8082)

**Responsabilidades:**
- Gesti√≥n de reservas
- Transiciones de estado (pending ‚Üí confirmed ‚Üí completed)
- Cancelaciones con pol√≠ticas
- Sistema de rese√±as
- Validaciones de negocio

**Base de Datos:** PostgreSQL (`booking_db`)

**Entidades:**
- `Booking` (id, spaceId, guestId, startTs, endTs, numGuests, totalPriceCents, status, paymentStatus)
- `Review` (id, bookingId, spaceId, guestId, rating, comment)
- `OutboxEvent` (para patr√≥n Outbox con Kafka)

**Estados de Booking:**

```
pending ‚îÄ‚îÄ(confirm)‚îÄ‚îÄ> confirmed ‚îÄ‚îÄ(complete)‚îÄ‚îÄ> completed
   ‚îÇ                       ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ(cancel)‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ> cancelled
```

**Endpoints Principales:**

```http
POST   /api/booking/bookings
GET    /api/booking/bookings/{id}
GET    /api/booking/bookings/guest/{guestId}
GET    /api/booking/bookings/space/{spaceId}
POST   /api/booking/bookings/{id}/confirm
POST   /api/booking/bookings/{id}/complete
POST   /api/booking/bookings/{id}/cancel

POST   /api/booking/reviews
GET    /api/booking/reviews/{id}
GET    /api/booking/reviews/space/{spaceId}
GET    /api/booking/reviews/reviewer/{reviewerId}
```

**Validaciones de Negocio:**
- Duraci√≥n m√≠nima: 1 hora
- Antelaci√≥n m√≠nima: 0 horas (inmediata)
- Cancelaci√≥n con 1 hora de antelaci√≥n
- Review solo en bookings completados
- No overlapping bookings

**Eventos Kafka Publicados:**
- `BookingCreatedEvent`
- `BookingConfirmedEvent`
- `BookingCancelledEvent`

---

### 6. Search Service (Puerto 8083)

**Responsabilidades:**
- B√∫squeda geoespacial de espacios
- Indexaci√≥n de espacios desde Catalog
- Filtros avanzados (precio, capacidad, rating)
- Ordenamiento por distancia/precio/rating

**Base de Datos:** PostgreSQL + PostGIS (`search_db`)

**Entidades:**
- `SpaceProjection` (vista materializada/tabla optimizada para lectura)
  - Incluye: geo (POINT con √≠ndice espacial), avg_rating, total_reviews

**Endpoints Principales:**

```http
GET    /api/search/spaces?lat={lat}&lon={lon}&radius={km}
POST   /api/search/spaces/filter
GET    /api/search/spaces/{id}
```

**Ejemplo de Query Geoespacial:**

```sql
SELECT 
    s.*,
    ST_Distance(
        s.geo::geography,
        ST_SetSRID(ST_MakePoint(?, ?), 4326)::geography
    ) / 1000 as distance_km
FROM search.spaces_projection s
WHERE ST_DWithin(
    s.geo::geography,
    ST_SetSRID(ST_MakePoint(?, ?), 4326)::geography,
    ?
)
AND s.status = 'active'
ORDER BY distance_km ASC
LIMIT ? OFFSET ?
```

**Eventos Kafka Consumidos:**
- `SpaceCreatedEvent` ‚Üí Crear proyecci√≥n
- `SpaceUpdatedEvent` ‚Üí Actualizar proyecci√≥n
- `ReviewCreatedEvent` ‚Üí Recalcular rating promedio

---

## üíæ Modelo de Datos

### Diagrama Entidad-Relaci√≥n (Simplificado)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    USER     ‚îÇ         ‚îÇ    SPACE     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ id (PK)     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ owner_id(FK) ‚îÇ
‚îÇ email       ‚îÇ         ‚îÇ title        ‚îÇ
‚îÇ password    ‚îÇ         ‚îÇ description  ‚îÇ
‚îÇ role        ‚îÇ         ‚îÇ lat, lon     ‚îÇ
‚îÇ status      ‚îÇ         ‚îÇ capacity     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ price        ‚îÇ
                        ‚îÇ status       ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚îÇ 1:N
                               ‚îÇ
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ   BOOKING    ‚îÇ
                        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                        ‚îÇ id (PK)      ‚îÇ
                        ‚îÇ space_id(FK) ‚îÇ
                        ‚îÇ guest_id(FK) ‚îÇ
                        ‚îÇ start_ts     ‚îÇ
                        ‚îÇ end_ts       ‚îÇ
                        ‚îÇ status       ‚îÇ
                        ‚îÇ payment_sts  ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚îÇ 1:1
                               ‚îÇ
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ    REVIEW    ‚îÇ
                        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                        ‚îÇ id (PK)      ‚îÇ
                        ‚îÇ booking_id   ‚îÇ
                        ‚îÇ rating       ‚îÇ
                        ‚îÇ comment      ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Relaciones Clave

1. **User ‚Üí Space** (1:N): Un host puede tener m√∫ltiples espacios
2. **Space ‚Üí Booking** (1:N): Un espacio puede tener m√∫ltiples reservas
3. **User ‚Üí Booking** (1:N): Un guest puede tener m√∫ltiples reservas
4. **Booking ‚Üí Review** (1:1): Una reserva puede tener una rese√±a

### √çndices Importantes

**Catalog Service:**
```sql
CREATE INDEX idx_space_owner ON catalog.spaces(owner_id);
CREATE INDEX idx_space_status ON catalog.spaces(status);
```

**Booking Service:**
```sql
CREATE INDEX idx_booking_guest ON booking.bookings(guest_id);
CREATE INDEX idx_booking_space ON booking.bookings(space_id);
CREATE INDEX idx_booking_dates ON booking.bookings(start_ts, end_ts);
```

**Search Service:**
```sql
CREATE INDEX idx_space_geo ON search.spaces_projection USING GIST(geo);
CREATE INDEX idx_space_status ON search.spaces_projection(status);
```

---

## üîê Autenticaci√≥n y Seguridad

### Flujo de Autenticaci√≥n

```
1. Cliente ‚Üí POST /api/auth/login {email, password}
2. Auth Service ‚Üí Valida credenciales (BCrypt)
3. Auth Service ‚Üí Genera JWT (HS512)
4. Cliente ‚Üê {accessToken, refreshToken, user}

5. Cliente ‚Üí GET /api/catalog/spaces (Authorization: Bearer {token})
6. API Gateway ‚Üí Valida JWT (firma + expiraci√≥n)
7. API Gateway ‚Üí Extrae claims (userId, role)
8. API Gateway ‚Üí Forward request con headers:
   - X-User-Id: {userId}
   - X-User-Role: {role}
9. Catalog Service ‚Üí Usa headers para l√≥gica de negocio
10. Cliente ‚Üê Respuesta
```

### Configuraci√≥n de Seguridad

**API Gateway (WebFlux):**

```java
@Bean
SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http) {
    return http
        .csrf(ServerHttpSecurity.CsrfSpec::disable)
        .authorizeExchange(ex -> ex
            .pathMatchers("/", "/actuator/**", "/api/auth/**", "/api/search/**").permitAll()
            .anyExchange().authenticated()
        )
        .oauth2ResourceServer(oauth -> oauth.jwt())
        .build();
}

@Bean
ReactiveJwtDecoder jwtDecoder() {
    SecretKey key = new SecretKeySpec(
        jwtSecret.getBytes(StandardCharsets.UTF_8), 
        "HmacSHA512"
    );
    return NimbusReactiveJwtDecoder.withSecretKey(key)
        .macAlgorithm(MacAlgorithm.HS512)
        .build();
}
```

**Microservicios (MVC):**

```java
@Bean
SecurityFilterChain securityFilterChain(HttpSecurity http) {
    return http
        .csrf(csrf -> csrf.disable())
        .sessionManagement(sm -> sm.sessionCreationPolicy(STATELESS))
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/actuator/**").permitAll()
            .anyRequest().authenticated()
        )
        .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class)
        .build();
}
```

### Roles y Permisos

| Rol | Permisos |
|-----|----------|
| **GUEST** | Buscar espacios, crear reservas, dejar rese√±as |
| **HOST** | Todo lo de GUEST + crear/gestionar espacios |
| **ADMIN** | Acceso completo (futuro) |

### Validaci√≥n en Servicios

```java
// Ejemplo en Catalog Service
public SpaceDTO createSpace(CreateSpaceDTO dto) {
    Authentication auth = SecurityContextHolder.getContext().getAuthentication();
    boolean isHost = auth.getAuthorities().stream()
        .anyMatch(a -> a.getAuthority().equals("ROLE_HOST"));
    
    if (!isHost) {
        throw new ForbiddenException("Solo hosts pueden crear espacios");
    }
    
    // ... l√≥gica
}
```

---

## üîÑ Flujos de Negocio

### 1. Flujo de Registro y Login

```
Usuario ‚Üí Register ‚Üí Auth Service
                     ‚Üì
                 Hash password (BCrypt)
                     ‚Üì
                 Guardar en MySQL
                     ‚Üì
                 Login con credenciales
                     ‚Üì
                 Generar JWT
                     ‚Üì
                 Retornar {accessToken, refreshToken}
```

### 2. Flujo de Creaci√≥n de Espacio

```
Host ‚Üí POST /api/catalog/spaces (JWT)
       ‚Üì
API Gateway ‚Üí Valida JWT
       ‚Üì
Catalog Service ‚Üí Valida rol HOST
       ‚Üì
Guarda en PostgreSQL (status: draft)
       ‚Üì
Publica SpaceCreatedEvent a Kafka
       ‚Üì
Search Service ‚Üí Consume evento
       ‚Üì
Indexa en spaces_projection
       ‚Üì
Host ‚Üê Space creado
```

### 3. Flujo de B√∫squeda

```
Usuario ‚Üí GET /api/search/spaces?lat=X&lon=Y&radius=Z
          ‚Üì
API Gateway ‚Üí Forward (p√∫blico, no JWT)
          ‚Üì
Search Service ‚Üí Query geoespacial con PostGIS
          ‚Üì
Calcula distancias, aplica filtros
          ‚Üì
Usuario ‚Üê Lista de espacios cercanos
```

### 4. Flujo Completo de Reserva

```
Guest ‚Üí Buscar espacio
        ‚Üì
      Ver detalle
        ‚Üì
      Crear reserva (pending)
        ‚Üì
Booking Service ‚Üí Validar disponibilidad
        ‚Üì
      Calcular precio
        ‚Üì
      Guardar en BD (status: pending)
        ‚Üì
Guest ‚Üê bookingId
        ‚Üì
      Pagar (simulado)
        ‚Üì
      Confirmar reserva (paymentIntentId)
        ‚Üì
Booking Service ‚Üí Cambiar status a confirmed
        ‚Üì
      Publicar BookingConfirmedEvent
        ‚Üì
      (Futuro: Enviar email confirmaci√≥n)
        ‚Üì
Guest ‚Üê Reserva confirmada
        ‚Üì
      [Espera a fecha de reserva]
        ‚Üì
      Completar reserva
        ‚Üì
Booking Service ‚Üí Cambiar status a completed
        ‚Üì
Guest ‚Üê Puede dejar rese√±a
        ‚Üì
      Crear review (rating + comment)
        ‚Üì
Booking Service ‚Üí Validar que booking est√© completed
        ‚Üì
      Guardar review
        ‚Üì
      Publicar ReviewCreatedEvent
        ‚Üì
Search Service ‚Üí Recalcular avg_rating del espacio
        ‚Üì
Guest ‚Üê Review creada
```

---

## üîó Comunicaci√≥n Entre Servicios

### S√≠ncrona (HTTP REST)

**Uso:** Operaciones CRUD, consultas en tiempo real

**V√≠a:** API Gateway ‚Üí Eureka ‚Üí Microservicio

**Ejemplo:**
```java
// No hay llamadas HTTP directas entre microservicios
// Todo pasa por API Gateway
```

### As√≠ncrona (Kafka)

**Uso:** Propagaci√≥n de eventos, consistencia eventual

**Topics:**
- `space.events` (SpaceCreated, SpaceUpdated)
- `booking.events` (BookingCreated, BookingConfirmed, BookingCancelled)
- `review.events` (ReviewCreated)

**Patr√≥n Outbox:**

```java
@Transactional
public BookingDTO confirmBooking(UUID id, String paymentIntentId) {
    // 1. Actualizar booking
    booking.setStatus(BookingStatus.confirmed);
    bookingRepository.save(booking);
    
    // 2. Guardar evento en outbox (misma transacci√≥n)
    OutboxEvent event = OutboxEvent.builder()
        .aggregateId(id)
        .eventType("BookingConfirmed")
        .payload(toJson(booking))
        .build();
    outboxRepository.save(event);
    
    // 3. Scheduled job env√≠a eventos a Kafka
    return toDTO(booking);
}
```

**Consumer en Search Service:**

```java
@KafkaListener(topics = "space.events", groupId = "search-service")
public void handleSpaceEvent(String eventJson) {
    SpaceCreatedEvent event = fromJson(eventJson);
    
    SpaceProjection projection = SpaceProjection.builder()
        .spaceId(event.getSpaceId())
        .title(event.getTitle())
        .geo(createPoint(event.getLat(), event.getLon()))
        .build();
    
    repository.save(projection);
}
```

---

## ‚ö†Ô∏è Manejo de Errores

### Jerarqu√≠a de Excepciones

```
RuntimeException
‚îú‚îÄ‚îÄ BusinessValidationException (400)
‚îÇ   ‚îú‚îÄ‚îÄ BookingValidationException
‚îÇ   ‚îî‚îÄ‚îÄ SpaceValidationException
‚îú‚îÄ‚îÄ ResourceNotFoundException (404)
‚îÇ   ‚îú‚îÄ‚îÄ BookingNotFoundException
‚îÇ   ‚îî‚îÄ‚îÄ SpaceNotFoundException
‚îú‚îÄ‚îÄ BookingStateException (400)
‚îî‚îÄ‚îÄ ForbiddenException (403)
```

### GlobalExceptionHandler

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BookingNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleNotFound(BookingNotFoundException ex) {
        return ResponseEntity.status(404).body(
            ErrorResponse.builder()
                .status(404)
                .error("Not Found")
                .message(ex.getMessage())
                .timestamp(LocalDateTime.now())
                .build()
        );
    }
    
    @ExceptionHandler(BookingStateException.class)
    public ResponseEntity<ErrorResponse> handleInvalidState(BookingStateException ex) {
        return ResponseEntity.status(400).body(
            ErrorResponse.builder()
                .status(400)
                .error("Invalid State")
                .message(String.format(
                    "Estado inv√°lido: actual='%s', requerido='%s'",
                    ex.getCurrentState(),
                    ex.getRequiredState()
                ))
                .timestamp(LocalDateTime.now())
                .build()
        );
    }
}
```

### Respuestas de Error Est√°ndar

```json
{
  "timestamp": "2025-10-30T12:30:45",
  "status": 400,
  "error": "Bad Request",
  "message": "La reserva debe ser de al menos 1 hora"
}
```

---

## üåê Endpoints API

Ver documentaci√≥n completa en: **[POSTMAN_ENDPOINTS.md](POSTMAN_ENDPOINTS.md)**

### Resumen por Servicio

**Auth Service (18 endpoints)**
- Registro, login, refresh token
- Gesti√≥n de perfil

**Catalog Service (12 endpoints)**
- CRUD de espacios
- Gesti√≥n de disponibilidad

**Booking Service (15 endpoints)**
- Gesti√≥n de reservas
- Sistema de rese√±as

**Search Service (3 endpoints)**
- B√∫squeda geoespacial
- Filtros avanzados

**Total:** 48 endpoints funcionales

---

## üß™ Tests Automatizados

### Tests E2E (test-e2e-completo.sh)

**Suite incluye:**

1. **Health Checks** (6 tests)
   - Verifica que todos los servicios respondan 200

2. **Registro en Eureka** (5 tests)
   - Valida que servicios est√©n registrados

3. **Autenticaci√≥n** (2 tests)
   - Registro de usuario
   - Login y obtenci√≥n de JWT

4. **Catalog Service** (3 tests)
   - Crear espacio
   - Listar espacios
   - Obtener por ID

5. **Search Service** (2 tests)
   - B√∫squeda geoespacial
   - Obtener espacio por ID

6. **Booking Service** (5 tests)
   - Crear reserva
   - Obtener reservas del guest
   - Confirmar reserva
   - Completar reserva
   - Crear review

7. **Seguridad** (2 tests)
   - Acceso sin JWT (debe fallar)
   - Acceso p√∫blico

8. **Eventos Kafka** (1 test)
   - Verificar propagaci√≥n de eventos

9. **Actuator** (3 tests)
   - Health endpoints
   - M√©tricas
   - Gateway routes

**Ejecutar:**
```bash
./test-e2e-completo.sh
```

**Resultado esperado:**
```
Tests ejecutados: 29
Tests exitosos: 29 ‚úÖ
Tests fallidos: 0 ‚ùå
Tasa de √©xito: 100%
```

### Tests Unitarios (Futuro)

```bash
# Por servicio
cd catalog_microservice
mvn test

# Coverage report
mvn jacoco:report
open target/site/jacoco/index.html
```

---

## ‚ú® Buenas Pr√°cticas Implementadas

### 1. Arquitectura y Dise√±o

‚úÖ **Separation of Concerns**: Cada microservicio tiene responsabilidades claras  
‚úÖ **DDD**: Entidades, Value Objects, Repositories bien definidos  
‚úÖ **SOLID Principles**: C√≥digo extensible y mantenible  
‚úÖ **Clean Architecture**: Capas bien separadas (Controller ‚Üí Service ‚Üí Repository)  

### 2. C√≥digo

‚úÖ **DTO Pattern**: Separaci√≥n entre modelos de dominio y API  
‚úÖ **Mapeo autom√°tico**: MapStruct para conversiones  
‚úÖ **Lombok**: Reducci√≥n de boilerplate  
‚úÖ **Exception Handling**: Excepciones espec√≠ficas por dominio  
‚úÖ **Logging**: SLF4J con logs estructurados  

### 3. Seguridad

‚úÖ **JWT Stateless**: No sesiones en servidor  
‚úÖ **Password Hashing**: BCrypt con salt  
‚úÖ **HTTPS Ready**: Configurado para SSL  
‚úÖ **CORS**: Configurado en API Gateway  
‚úÖ **Rate Limiting**: Protecci√≥n contra abuso  

### 4. Performance

‚úÖ **Cach√© distribuida**: Redis para datos frecuentes  
‚úÖ **√çndices de BD**: Queries optimizadas  
‚úÖ **Connection Pooling**: HikariCP configurado  
‚úÖ **Lazy Loading**: JPA fetch estrat√©gico  

### 5. Resiliencia

‚úÖ **Circuit Breaker**: Resilience4j en Gateway  
‚úÖ **Retry Logic**: Reintentos autom√°ticos  
‚úÖ **Timeouts**: Configurados en todos los servicios  
‚úÖ **Graceful Shutdown**: Spring Actuator  

### 6. Observabilidad

‚úÖ **Health Checks**: `/actuator/health` en todos los servicios  
‚úÖ **Metrics**: Prometheus-ready con Micrometer  
‚úÖ **Logs Estructurados**: JSON logging  
‚úÖ **Correlation IDs**: Trazabilidad de requests  

### 7. DevOps

‚úÖ **Infrastructure as Code**: Docker Compose  
‚úÖ **Scripts Automatizados**: Start/stop/recompile  
‚úÖ **Environment Variables**: Configuraci√≥n externa  
‚úÖ **Health Checks en Docker**: Restart autom√°tico  

---

## üìä M√©tricas del Sistema

### Rendimiento Actual (Local)

| M√©trica | Valor |
|---------|-------|
| Latencia promedio (p50) | <100ms |
| Latencia p95 | <300ms |
| Throughput | ~200 req/s |
| Tiempo de arranque | ~45s |
| Uso de RAM (todos los servicios) | ~2.5GB |

### Capacidad Estimada (Producci√≥n)

| Escenario | Usuarios Concurrentes | RPS | Infraestructura |
|-----------|----------------------|-----|-----------------|
| MVP | 100 | 50 | 2 pods/servicio |
| Crecimiento | 1,000 | 500 | 4 pods/servicio |
| Escala | 10,000 | 2,000 | 8 pods/servicio + CDN |

---

## üìö Referencias y Recursos

### Documentaci√≥n Oficial

- [Spring Boot Reference](https://docs.spring.io/spring-boot/docs/current/reference/html/)
- [Spring Cloud Gateway](https://cloud.spring.io/spring-cloud-gateway/reference/html/)
- [Spring Security](https://docs.spring.io/spring-security/reference/index.html)
- [PostGIS Documentation](https://postgis.net/documentation/)
- [Apache Kafka](https://kafka.apache.org/documentation/)

### Patrones y Arquitectura

- [Microservices Patterns (Chris Richardson)](https://microservices.io/patterns/)
- [Domain-Driven Design (Eric Evans)](https://domainlanguage.com/ddd/)
- [Event Sourcing](https://martinfowler.com/eaaDev/EventSourcing.html)

---

**Documento actualizado:** Octubre 2025  
**Mantenedor:** Equipo de Backend  
**Pr√≥xima revisi√≥n:** Trimestral

